/*!
 * palettify v0.0.0 
 * (c) 2017 Dobromir Hristov
 * Released under the MIT License.
 */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):e.palettify=t()}(this,function(){"use strict";function e(){function e(e){var r=e;if(!e)throw Error("Target is not an element",e);return"IMG"!==e.tagName&&e.style.backgroundImage&&Error("Tag provided is not an image and does not have a background-image style attached to it."),"IMG"!==e.tagName&&(r=new Image(e.offsetWidth,e.offsetHeight),r.src=e.style.backgroundImage.replace("url(","").replace(")","").replace(/"/gi,"")),(new t).getPalette(r,3)}function r(e,t){return"rgba("+e[0]+", "+e[1]+", "+e[2]+", "+t+")"}function n(e,t){var n,o=i.options,a=o.opacity,u=o.opacitySecondary,c=o.boxShadowTemplate,s=e[i.options.colorIndexToUse],f=r(s,a),h=r(s,u);n=c?c.replace("{color}",f).replace("{colorSecondary}",h):"0 2px 2px "+f+", 0 4px 4px "+f+", 0 8px 8px "+f+", 0 16px 16px "+f+", 0 32px 32px "+h+", 0 64px 64px "+h,t.colors=e,t.rgbaColor=f,t.rgbaColorSecondary=h,t.boxShadow=n}var o=!1,a={hoverTarget:Error("Please provide hoverTarget"),imageTarget:Error("Please provide ImageSrc"),attachBoxShadowTo:null,opacity:.2,opacitySecondary:.2,hoverClass:"box-shadow-attached",colorIndexToUse:0,enterEvent:"mouseenter",leaveEvent:"mouseleave",boxShadowTemplate:""},i={options:{},elements:[],collectElements:function(){var e=i.options.hoverTarget;if("string"==typeof e&&(e=document.querySelectorAll(e)),e.length)for(var t=0;t<e.length;t++){var r=e[t],n=r.querySelector(i.options.imageTarget),o={hoverTarget:r,image:n};i.elements.push(o)}},attachBoxShadowToCollection:function(){i.elements.forEach(function(t){n(e(t.image),t)})},enterHandler:function(e){return function(t){var r=t.currentTarget.querySelector(i.options.attachBoxShadowTo||i.options.imageTarget);r&&(r.classList.add(i.options.hoverClass),r.style.boxShadow=e.boxShadow)}},leaveHandler:function(e){return function(e){var t=e.currentTarget.querySelector(i.options.attachBoxShadowTo||i.options.imageTarget);t&&(t.classList.remove(i.options.hoverClass),t.style.boxShadow="")}},attachEventListeners:function(){var e=i.options,t=e.enterEvent,r=e.leaveEvent;i.elements.forEach(function(e){e.enterHandler=i.enterHandler(e),e.leaveHandler=i.leaveHandler(e),Array.isArray(t)&&Array.isArray(r)?(t.forEach(function(t){e.hoverTarget.addEventListener(t,e.enterHandler,!1)}),r.forEach(function(t){e.hoverTarget.addEventListener(t,e.leaveHandler,!1)})):(e.hoverTarget.addEventListener(t,e.enterHandler,!1),e.hoverTarget.addEventListener(r,e.leaveHandler,!1))})},detachEventListeners:function(){var e=i.options,t=e.enterEvent,r=e.leaveEvent;i.elements.forEach(function(e){Array.isArray(t)&&Array.isArray(r)?(t.forEach(function(t){e.hoverTarget.removeEventListener(t,e.enterHandler,!1)}),r.forEach(function(t){e.hoverTarget.removeEventListener(t,e.leaveHandler,!1)})):(e.hoverTarget.removeEventListener(t,e.enterHandler,!1),e.hoverTarget.removeEventListener(r,e.leaveHandler,!1))})},init:function(e){if(o)throw new Error("Palettify is already initialized");return i.options=Object.assign({},a,e),i.collectElements(),i.attachBoxShadowToCollection(),i.attachEventListeners(),o=!0,i},destroy:function(){i.detachEventListeners(),i.elements=[],o=!1},reInit:function(){i.destroy(),i.init(i.options)},setOptions:function(e,t){void 0===t&&(t=!0),i.options=Object.assign({},i.options,e),t&&i.reInit()},isInitialized:function(){return o}};return i}var t=function(){var e=function(){},t=function(e){this.canvas=document.createElement("canvas"),this.context=this.canvas.getContext("2d"),document.body.appendChild(this.canvas),this.width=this.canvas.width=e.width,this.height=this.canvas.height=e.height,this.context.drawImage(e,0,0,this.width,this.height)};t.prototype.clear=function(){this.context.clearRect(0,0,this.width,this.height)},t.prototype.update=function(e){this.context.putImageData(e,0,0)},t.prototype.getPixelCount=function(){return this.width*this.height},t.prototype.getImageData=function(){return this.context.getImageData(0,0,this.width,this.height)},t.prototype.removeCanvas=function(){this.canvas.parentNode.removeChild(this.canvas)};var r={map:function(e,t){var r={};return t?e.map(function(e,n){return r.index=n,t.call(r,e)}):e.slice()},naturalOrder:function(e,t){return e<t?-1:e>t?1:0},sum:function(e,t){var r={};return e.reduce(t?function(e,n,o){return r.index=o,e+t.call(r,n)}:function(e,t){return e+t},0)},max:function(e,t){return Math.max.apply(null,t?r.map(e,t):e)}},n=function(){function e(e,t,r){return(e<<2*s)+(t<<s)+r}function t(e){function t(){r.sort(e),n=!0}var r=[],n=!1;return{push:function(e){r.push(e),n=!1},peek:function(e){return n||t(),void 0===e&&(e=r.length-1),r[e]},pop:function(){return n||t(),r.pop()},size:function(){return r.length},map:function(e){return r.map(e)},debug:function(){return n||t(),r}}}function n(e,t,r,n,o,a,i){var u=this;u.r1=e,u.r2=t,u.g1=r,u.g2=n,u.b1=o,u.b2=a,u.histo=i}function o(){this.vboxes=new t(function(e,t){return r.naturalOrder(e.vbox.count()*e.vbox.volume(),t.vbox.count()*t.vbox.volume())})}function a(t){var r,n,o,a,i=1<<3*s,u=new Array(i);return t.forEach(function(t){n=t[0]>>f,o=t[1]>>f,a=t[2]>>f,r=e(n,o,a),u[r]=(u[r]||0)+1}),u}function i(e,t){var r,o,a,i=1e6,u=0,c=1e6,s=0,h=1e6,l=0;return e.forEach(function(e){r=e[0]>>f,o=e[1]>>f,a=e[2]>>f,r<i?i=r:r>u&&(u=r),o<c?c=o:o>s&&(s=o),a<h?h=a:a>l&&(l=a)}),new n(i,u,c,s,h,l,t)}function u(t,n){if(n.count()){var o=n.r2-n.r1+1,a=n.g2-n.g1+1,i=n.b2-n.b1+1,u=r.max([o,a,i]);if(1==n.count())return[n.copy()];var c,s,f,h,l,v=0,p=[],g=[];if(u==o)for(c=n.r1;c<=n.r2;c++){for(h=0,s=n.g1;s<=n.g2;s++)for(f=n.b1;f<=n.b2;f++)l=e(c,s,f),h+=t[l]||0;v+=h,p[c]=v}else if(u==a)for(c=n.g1;c<=n.g2;c++){for(h=0,s=n.r1;s<=n.r2;s++)for(f=n.b1;f<=n.b2;f++)l=e(s,c,f),h+=t[l]||0;v+=h,p[c]=v}else for(c=n.b1;c<=n.b2;c++){for(h=0,s=n.r1;s<=n.r2;s++)for(f=n.g1;f<=n.g2;f++)l=e(s,f,c),h+=t[l]||0;v+=h,p[c]=v}return p.forEach(function(e,t){g[t]=v-e}),function(e){var t,r,o,a,i,u=e+"1",s=e+"2",f=0;for(c=n[u];c<=n[s];c++)if(p[c]>v/2){for(o=n.copy(),a=n.copy(),t=c-n[u],r=n[s]-c,i=t<=r?Math.min(n[s]-1,~~(c+r/2)):Math.max(n[u],~~(c-1-t/2));!p[i];)i++;for(f=g[i];!f&&p[i-1];)f=g[--i];return o[s]=i,a[u]=o[s]+1,[o,a]}}(u==o?"r":u==a?"g":"b")}}function c(e,n){function c(e,t){for(var r,n=1,o=0;o<h;)if(r=e.pop(),r.count()){var a=u(s,r),i=a[0],c=a[1];if(!i)return;if(e.push(i),c&&(e.push(c),n++),n>=t)return;if(o++>h)return}else e.push(r),o++}if(!e.length||n<2||n>256)return!1;var s=a(e),f=0;s.forEach(function(){f++});var v=i(e,s),p=new t(function(e,t){return r.naturalOrder(e.count(),t.count())});p.push(v),c(p,l*n);for(var g=new t(function(e,t){return r.naturalOrder(e.count()*e.volume(),t.count()*t.volume())});p.size();)g.push(p.pop());c(g,n-g.size());for(var d=new o;g.size();)d.push(g.pop());return d}var s=5,f=8-s,h=1e3,l=.75;return n.prototype={volume:function(e){var t=this;return t._volume&&!e||(t._volume=(t.r2-t.r1+1)*(t.g2-t.g1+1)*(t.b2-t.b1+1)),t._volume},count:function(t){var r=this,n=r.histo;if(!r._count_set||t){var o,a,i,u,c=0;for(a=r.r1;a<=r.r2;a++)for(i=r.g1;i<=r.g2;i++)for(u=r.b1;u<=r.b2;u++)o=e(a,i,u),c+=n[o]||0;r._count=c,r._count_set=!0}return r._count},copy:function(){var e=this;return new n(e.r1,e.r2,e.g1,e.g2,e.b1,e.b2,e.histo)},avg:function(t){var r=this,n=r.histo;if(!r._avg||t){var o,a,i,u,c,f=0,h=1<<8-s,l=0,v=0,p=0;for(a=r.r1;a<=r.r2;a++)for(i=r.g1;i<=r.g2;i++)for(u=r.b1;u<=r.b2;u++)c=e(a,i,u),o=n[c]||0,f+=o,l+=o*(a+.5)*h,v+=o*(i+.5)*h,p+=o*(u+.5)*h;r._avg=f?[~~(l/f),~~(v/f),~~(p/f)]:[~~(h*(r.r1+r.r2+1)/2),~~(h*(r.g1+r.g2+1)/2),~~(h*(r.b1+r.b2+1)/2)]}return r._avg},contains:function(e){var t=this,r=e[0]>>f,n=e[1]>>f,o=e[2]>>f;return r>=t.r1&&r<=t.r2&&n>=t.g1&&n<=t.g2&&o>=t.b1&&o<=t.b2}},o.prototype={push:function(e){this.vboxes.push({vbox:e,color:e.avg()})},palette:function(){return this.vboxes.map(function(e){return e.color})},size:function(){return this.vboxes.size()},map:function(e){for(var t=this.vboxes,r=0;r<t.size();r++)if(t.peek(r).vbox.contains(e))return t.peek(r).color;return this.nearest(e)},nearest:function(e){for(var t,r,n,o=this.vboxes,a=0;a<o.size();a++)((r=Math.sqrt(Math.pow(e[0]-o.peek(a).color[0],2)+Math.pow(e[1]-o.peek(a).color[1],2)+Math.pow(e[2]-o.peek(a).color[2],2)))<t||void 0===t)&&(t=r,n=o.peek(a).color);return n},forcebw:function(){var e=this.vboxes;e.sort(function(e,t){return r.naturalOrder(r.sum(e.color),r.sum(t.color))});var t=e[0].color;t[0]<5&&t[1]<5&&t[2]<5&&(e[0].color=[0,0,0]);var n=e.length-1,o=e[n].color;o[0]>251&&o[1]>251&&o[2]>251&&(e[n].color=[255,255,255])}},{quantize:c}}();return e.prototype.getColor=function(e,t){return this.getPalette(e,5,t)[0]},e.prototype.getPalette=function(e,r,o){(void 0===r||r<2||r>256)&&(r=10),(void 0===o||o<1)&&(o=10);for(var a,i,u,c,s=new t(e),f=s.getImageData(),h=f.data,l=s.getPixelCount(),v=[],p=0;p<l;p+=o)a=4*p,i=h[a+0],u=h[a+1],c=h[a+2],h[a+3]>=125&&(i>250&&u>250&&c>250||v.push([i,u,c]));var g=n.quantize(v,r),d=g?g.palette():null;return s.removeCanvas(),d},e.prototype.getColorFromUrl=function(e,t,r){sourceImage=document.createElement("img");var n=this;sourceImage.addEventListener("load",function(){t(n.getPalette(sourceImage,5,r)[0],e)}),sourceImage.src=e},e.prototype.getImageData=function(e,t){xhr=new XMLHttpRequest,xhr.open("GET",e,!0),xhr.responseType="arraybuffer",xhr.onload=function(e){if(200==this.status){uInt8Array=new Uint8Array(this.response),r=uInt8Array.length,binaryString=new Array(r);for(var r=0;r<uInt8Array.length;r++)binaryString[r]=String.fromCharCode(uInt8Array[r]);data=binaryString.join(""),base64=window.btoa(data),t("data:image/png;base64,"+base64)}},xhr.send()},e.prototype.getColorAsync=function(e,t,r){var n=this;this.getImageData(e,function(e){sourceImage=document.createElement("img"),sourceImage.addEventListener("load",function(){t(n.getPalette(sourceImage,5,r)[0],this)}),sourceImage.src=e})},e}();return e});